(function(a){var c=a.event,b;c.special.smartresize={setup:function(){a(this).bind("resize",c.special.smartresize.handler)},teardown:function(){a(this).unbind("resize",c.special.smartresize.handler)},handler:function(f,e){var h=this,i=arguments;f.type="smartresize";b&&clearTimeout(b);b=setTimeout(function(){jQuery.event.handle.apply(h,i)},e==="execAsap"?0:100)}};a.fn.smartresize=function(d){return d?this.bind("smartresize",d):this.trigger("smartresize",["execAsap"])};a.fn.masonry=function(e,d){var f={getBricks:function(i,g,h){var j=h.itemSelector===undefined;g.$bricks=h.appendedContent===undefined?j?i.children():i.find(h.itemSelector):j?h.appendedContent:h.appendedContent.filter(h.itemSelector)},placeBrick:function(p,r,s,q,n){r=Math.min.apply(Math,s);for(var l=r+p.outerHeight(true),o=s.length,j=o,g=q.colCount+1-o;o--;){if(s[o]==r){j=o}}p.applyStyle({left:q.colW*j+q.posLeft,top:r},a.extend(true,{},n.animationOptions));for(o=0;o<g;o++){q.colY[j+o]=l}},setup:function(i,g,h){f.getBricks(i,h,g);if(h.masoned){h.previousData=i.data("masonry")}h.colW=g.columnWidth===undefined?h.masoned?h.previousData.colW:h.$bricks.outerWidth(true):g.columnWidth;h.colCount=Math.floor(i.width()/h.colW);h.colCount=Math.max(h.colCount,1)},arrange:function(k,g,i){var l;if(!i.masoned||g.appendedContent!==undefined){i.$bricks.css("position","absolute")}if(i.masoned){i.posTop=i.previousData.posTop;i.posLeft=i.previousData.posLeft}else{k.css("position","relative");var j=a(document.createElement("div"));k.prepend(j);i.posTop=Math.round(j.position().top);i.posLeft=Math.round(j.position().left);j.remove()}if(i.masoned&&g.appendedContent!==undefined){i.colY=i.previousData.colY;for(l=i.previousData.colCount;l<i.colCount;l++){i.colY[l]=i.posTop}}else{i.colY=[];for(l=i.colCount;l--;){i.colY.push(i.posTop)}}a.fn.applyStyle=i.masoned&&g.animate?a.fn.animate:a.fn.css;g.singleMode?i.$bricks.each(function(){var h=a(this);f.placeBrick(h,i.colCount,i.colY,i,g)}):i.$bricks.each(function(){var o=a(this),q=Math.ceil(o.outerWidth(true)/i.colW);q=Math.min(q,i.colCount);if(q===1){f.placeBrick(o,i.colCount,i.colY,i,g)}else{var n=i.colCount+1-q,h=[];for(l=0;l<n;l++){var r=i.colY.slice(l,l+q);h[l]=Math.max.apply(Math,r)}f.placeBrick(o,n,h,i,g)}});i.wallH=Math.max.apply(Math,i.colY);k.applyStyle({height:i.wallH-i.posTop},a.extend(true,[],g.animationOptions));i.masoned||setTimeout(function(){k.addClass("masoned")},1);d.call(i.$bricks);k.data("masonry",i)},resize:function(i,g,h){h.masoned=!!i.data("masonry");var j=i.data("masonry").colCount;f.setup(i,g,h);h.colCount!=j&&f.arrange(i,g,h)}};return this.each(function(){var k=a(this),g={};g.masoned=!!k.data("masonry");var i=g.masoned?k.data("masonry").options:{},l=a.extend({},a.fn.masonry.defaults,i,e),j=i.resizeable;g.options=l.saveOptions?l:i;d=d||function(){};f.getBricks(k,g,l);if(!g.$bricks.length){return this}f.setup(k,l,g);f.arrange(k,l,g);!j&&l.resizeable&&a(window).bind("smartresize.masonry",function(){f.resize(k,l,g)});j&&!l.resizeable&&a(window).unbind("smartresize.masonry")})};a.fn.masonry.defaults={singleMode:false,columnWidth:undefined,itemSelector:undefined,appendedContent:undefined,saveOptions:true,resizeable:true,animate:false,animationOptions:{}}})(jQuery);$(function(){var a=a||[]});function Global(){this.init=function(){Global.installObservers();Cover.init();$(".radio").buttonset();FB.Event.subscribe("auth.logout",function(c){$("#nav").html("")});$("#registration a.fb_button").live("click",function(){if(RAILS_ENV=="production"){_paq.push(["trackConversion",{id:"7SXbBD9Fp588",value:null}]);mpmetrics.track("FB Login Clicked")}});FB.Event.subscribe("edge.create",function(c){liked_url=c;if(RAILS_ENV=="production"){_paq.push(["trackConversion",{id:"6Sk7qc8EKYUF",value:null}]);FB.getLoginStatus(function(d){if(d.session){id=d.session.uid;mpmetrics.track("Facebook Like Book",{fb_uid:id,url:liked_url})}else{mpmetrics.track("Facebook Like Book",{url:liked_url})}})}});$("#apple-store-banner").click(function(){if(RAILS_ENV=="production"){mpmetrics.track("AppleStore Banner Clicked")}});function a(c){var d=FB.Data.query("select first_name, hometown_location, pic_small from user where uid={0}",c.session.uid);d.wait(function(e){first_name=e[0].first_name;pic=e[0].pic_small;if(e[0].hometown_location==null){city="";country=""}else{city=e[0].hometown_location.city;country=e[0].hometown_location.country}b(pic,first_name);$.ajax({type:"POST",url:"/logins",dataType:"json",data:"country="+country+"&city="+city,success:function(f){if(f.new_login&&RAILS_ENV=="production"){_paq.push(["trackConversion",{id:"3F6mY45twfux",value:null}])}}})});$("#registration a").addClass("displaced")}function b(c,d){$("#nav").html('<div id="user_welcome"><img src="'+c+'"/><span class="name">Welcome back, '+d+"!</span></div>")}};this.installObservers=function(){}}Global=new Global();(function(d){function b(k){var j=d('meta[name="csrf-token"]').attr("content");if(j){k.setRequestHeader("X-CSRF-Token",j)}}if("ajaxPrefilter" in d){d.ajaxPrefilter(function(j,l,k){b(k)})}else{d(document).ajaxSend(function(j,k){b(k)})}function c(m,j,l){var k=new d.Event(j);m.trigger(k,l);return k.result!==false}function i(m){var o,k,n,j=m.attr("data-type")||(d.ajaxSettings&&d.ajaxSettings.dataType);if(m.is("form")){o=m.attr("method");k=m.attr("action");n=m.serializeArray();var l=m.data("ujs:submit-button");if(l){n.push(l);m.data("ujs:submit-button",null)}}else{o=m.attr("data-method");k=m.attr("href");n=null}d.ajax({url:k,type:o||"GET",data:n,dataType:j,beforeSend:function(q,p){if(p.dataType===undefined){q.setRequestHeader("accept","*/*;q=0.5, "+p.accepts.script)}return c(m,"ajax:beforeSend",[q,p])},success:function(q,p,r){m.trigger("ajax:success",[q,p,r])},complete:function(q,p){m.trigger("ajax:complete",[q,p])},error:function(r,p,q){m.trigger("ajax:error",[r,p,q])}})}function f(n){var k=n.attr("href"),p=n.attr("data-method"),l=d("meta[name=csrf-token]").attr("content"),o=d("meta[name=csrf-param]").attr("content"),m=d('<form method="post" action="'+k+'"></form>'),j='<input name="_method" value="'+p+'" type="hidden" />';if(o!==undefined&&l!==undefined){j+='<input name="'+o+'" value="'+l+'" type="hidden" />'}m.hide().append(j).appendTo("body");m.submit()}function g(j){j.find("input[data-disable-with]").each(function(){var k=d(this);k.data("ujs:enable-with",k.val()).val(k.attr("data-disable-with")).attr("disabled","disabled")})}function a(j){j.find("input[data-disable-with]").each(function(){var k=d(this);k.val(k.data("ujs:enable-with")).removeAttr("disabled")})}function h(j){var k=j.attr("data-confirm");return !k||(c(j,"confirm")&&confirm(k))}function e(k){var j=false;k.find("input[name][required]").each(function(){if(!d(this).val()){j=true}});return j}d("a[data-confirm], a[data-method], a[data-remote]").live("click.rails",function(k){var j=d(this);if(!h(j)){return false}if(j.attr("data-remote")!=undefined){i(j);return false}else{if(j.attr("data-method")){f(j);return false}}});d("form").live("submit.rails",function(l){var j=d(this),k=j.attr("data-remote")!=undefined;if(!h(j)){return false}if(e(j)){return !k}if(k){i(j);return false}else{setTimeout(function(){g(j)},13)}});d("form input[type=submit], form button[type=submit], form button:not([type])").live("click.rails",function(){var k=d(this);if(!h(k)){return false}var j=k.attr("name"),l=j?{name:j,value:k.val()}:null;k.closest("form").data("ujs:submit-button",l)});d("form").live("ajax:beforeSend.rails",function(j){if(this==j.target){g(d(this))}});d("form").live("ajax:complete.rails",function(j){if(this==j.target){a(d(this))}})})(jQuery);if(window.jQuery){(function(a){if(a.browser.msie){try{document.execCommand("BackgroundImageCache",false,true)}catch(b){}}a.fn.rating=function(d){if(this.length==0){return this}if(typeof arguments[0]=="string"){if(this.length>1){var c=arguments;return this.each(function(){a.fn.rating.apply(a(this),c)})}a.fn.rating[arguments[0]].apply(this,a.makeArray(arguments).slice(1)||[]);return this}var d=a.extend({},a.fn.rating.options,d||{});a.fn.rating.calls++;this.not(".star-rating-applied").addClass("star-rating-applied").each(function(){var g,l=a(this);var e=(this.name||"unnamed-rating").replace(/\[|\]/g,"_").replace(/^\_+|\_+$/g,"");var f=a(this.form||document.body);var k=f.data("rating");if(!k||k.call!=a.fn.rating.calls){k={count:0,call:a.fn.rating.calls}}var n=k[e];if(n){g=n.data("rating")}if(n&&g){g.count++}else{g=a.extend({},d||{},(a.metadata?l.metadata():(a.meta?l.data():null))||{},{count:0,stars:[],inputs:[]});g.serial=k.count++;n=a('<span class="star-rating-control"/>');l.before(n);n.addClass("rating-to-be-drawn");if(l.attr("disabled")){g.readOnly=true}n.append(g.cancel=a('<div class="rating-cancel"><a title="'+g.cancel+'">'+g.cancelValue+"</a></div>").mouseover(function(){a(this).rating("drain");a(this).addClass("star-rating-hover")}).mouseout(function(){a(this).rating("draw");a(this).removeClass("star-rating-hover")}).click(function(){a(this).rating("select")}).data("rating",g))}var j=a('<div class="star-rating rater-'+g.serial+'"><a title="'+(this.title||this.value)+'">'+this.value+"</a></div>");n.append(j);if(this.id){j.attr("id",this.id)}if(this.className){j.addClass(this.className)}if(g.half){g.split=2}if(typeof g.split=="number"&&g.split>0){var i=(a.fn.width?j.width():0)||g.starWidth;var h=(g.count%g.split),m=Math.floor(i/g.split);j.width(m).find("a").css({"margin-left":"-"+(h*m)+"px"})}if(g.readOnly){j.addClass("star-rating-readonly")}else{j.addClass("star-rating-live").mouseover(function(){a(this).rating("fill");a(this).rating("focus")}).mouseout(function(){a(this).rating("draw");a(this).rating("blur")}).click(function(){a(this).rating("select")})}if(this.checked){g.current=j}l.hide();l.change(function(){a(this).rating("select")});j.data("rating.input",l.data("rating.star",j));g.stars[g.stars.length]=j[0];g.inputs[g.inputs.length]=l[0];g.rater=k[e]=n;g.context=f;l.data("rating",g);n.data("rating",g);j.data("rating",g);f.data("rating",k)});a(".rating-to-be-drawn").rating("draw").removeClass("rating-to-be-drawn");return this};a.extend(a.fn.rating,{calls:0,focus:function(){var d=this.data("rating");if(!d){return this}if(!d.focus){return this}var c=a(this).data("rating.input")||a(this.tagName=="INPUT"?this:null);if(d.focus){d.focus.apply(c[0],[c.val(),a("a",c.data("rating.star"))[0]])}},blur:function(){var d=this.data("rating");if(!d){return this}if(!d.blur){return this}var c=a(this).data("rating.input")||a(this.tagName=="INPUT"?this:null);if(d.blur){d.blur.apply(c[0],[c.val(),a("a",c.data("rating.star"))[0]])}},fill:function(){var c=this.data("rating");if(!c){return this}if(c.readOnly){return}this.rating("drain");this.prevAll().andSelf().filter(".rater-"+c.serial).addClass("star-rating-hover")},drain:function(){var c=this.data("rating");if(!c){return this}if(c.readOnly){return}c.rater.children().filter(".rater-"+c.serial).removeClass("star-rating-on").removeClass("star-rating-hover")},draw:function(){var c=this.data("rating");if(!c){return this}this.rating("drain");if(c.current){c.current.data("rating.input").attr("checked","checked");c.current.prevAll().andSelf().filter(".rater-"+c.serial).addClass("star-rating-on")}else{a(c.inputs).removeAttr("checked")}c.cancel[c.readOnly||c.required?"hide":"show"]();this.siblings()[c.readOnly?"addClass":"removeClass"]("star-rating-readonly")},select:function(d,f){var e=this.data("rating");if(!e){return this}if(e.readOnly){return}e.current=null;if(typeof d!="undefined"){if(typeof d=="number"){return a(e.stars[d]).rating("select",undefined,f)}if(typeof d=="string"){a.each(e.stars,function(){if(a(this).data("rating.input").val()==d){a(this).rating("select",undefined,f)}})}}else{e.current=this[0].tagName=="INPUT"?this.data("rating.star"):(this.is(".rater-"+e.serial)?this:null)}this.data("rating",e);this.rating("draw");var c=a(e.current?e.current.data("rating.input"):null);if((f||f==undefined)&&e.callback){e.callback.apply(c[0],[c.val(),a("a",e.current)[0]])}},readOnly:function(c,d){var e=this.data("rating");if(!e){return this}e.readOnly=c||c==undefined?true:false;if(d){a(e.inputs).attr("disabled","disabled")}else{a(e.inputs).removeAttr("disabled")}this.data("rating",e);this.rating("draw")},disable:function(){this.rating("readOnly",true,true)},enable:function(){this.rating("readOnly",false,false)}});a.fn.rating.options={cancel:"Cancel Rating",cancelValue:"",split:0,starWidth:16};a(function(){a("input[type=radio].star").rating()})})(jQuery)}(function(){$(function(){window.compressText=function b(g,e){var f;if(g.length<e){return g}f=g.substring(0,(e-2));return f+"..."};window.setElementCover=function d(h,f){var g,e;g='<a href="/'+f[0].author_slug+"/"+f[0].cached_slug+'" class="no-underline">';h.children(".stable").append(g+'<img src="http://spreadsong-book-covers.s3.amazonaws.com/book_id'+f[0].id+'_size3.jpg"/></a>');if(h.hasClass("cover-with-title-here")){e=h.hasClass("small"||h.hasClass("tiny"))?40:61;h.append('<div class="text" style="display:none"> '+g+'<span class="title">'+b(f[0].pretty_title,e)+'</span></a><span class="type">Book</span></div>')}return $(".cover-here img, .cover-with-title-here img").bind("load",function(){return $(this).parents("a").siblings(".spinner").fadeOut(200,function(){$(this).parents().siblings(".text").fadeIn(1000);return $(this).siblings("a").children("img").fadeIn(1000)})})};window.setCoverForAudiobook=function a(h,f){var g,e;g='<a href="/'+f[0].author_slug+"/"+f[0].cached_slug+'" class="no-underline">';h.children(".stable").append(g+'<img src="http://spreadsong-audiobook-covers.s3.amazonaws.com/audiobook_id'+f[0].id+'_size3.jpg"/></a>');if(h.hasClass("cover-with-title-here")){e=h.hasClass("small"||h.hasClass("tiny"))?40:61;h.append('<div class="text" style="display:none">'+g+'<span class="title">'+b(f[0].pretty_title,e)+'</span></a><span class="type">Audiobook</span></div>')}return $(".cover-here img, .cover-with-title-here img").bind("load",function(){return $(this).parents("a").siblings(".spinner").fadeOut(200,function(){$(this).parents().siblings(".text").fadeIn(1000);return $(this).siblings("a").children("img").fadeIn(1000)})})};return window.coversForRelatedBooks=function c(){var h,f,g,e;h=$("ul.book-list li").map(function(){return $(this).attr("id").split("_")[1]});h=h.get();f=$("ul.book-list").hasClass("audiobooks");e=f?"json_audiobooks":"json_books";g=$(h).get().join(",");return $.getJSON(e,{id:g},function(i){return $.each(i,function(k,l){var n,j,m;n=[l.attrs];m=f?"ul.book-list li#audiobook_":" ul.book-list li#book_";j=m+l.attrs.id+" .cover-here";return f?a($(j),n):d($(j),n)})})}})})();(function(){$(function(){var c,g,f,b,e,a,d;$("img.cover-art").each(function(){var i,l,j,h,k;if($(this).height()<155){i=155-$(this).height();j=$(this).offset().left;h=$(this).offset().top+i;return $(this).offset((k=h),(l=j))}});a=$("#right-column .row .cover-here, #right-column .row .cover-with-title-here").size();if($("#right-column .row").hasClass("audiobooks")){d="/random_json_audiobooks/";c=true}else{d="/random_json_books/"}$.getJSON(d+a,function(h){return $.each($("#right-column .row .cover-here, #right-column .row .cover-with-title-here"),function(k,m){var j,i,l;l=h.length;j=Math.floor(Math.random()*l);i=h.splice(j,1);if(c){return setCoverForAudiobook($(this),i)}else{return setElementCover($(this),i)}})});f=$(".random-book");if(f.get(0)){e=f.size()}f.get(0)?$.getJSON("/random_json_books/"+e,function(h){return $.each($(".random-book"),function(k,m){var j,i,l;j=Math.floor(Math.random()*l);i=h.splice(j,1);l=h.length;return setElementCover($(this),i)})}):null;g=$(".random-audiobook");if(g.get(0)){b=g.size()}return g.get(0)?$.getJSON("/random_json_audiobooks/"+b,function(h){return $.each($(".random-audiobook"),function(k,m){var j,i,l;j=Math.floor(Math.random()*l);i=h.splice(j,1);l=h.length;return window.setCoverForAudiobook($(this),i)})}):null})})();